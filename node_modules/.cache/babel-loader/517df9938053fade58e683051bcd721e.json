{"ast":null,"code":"var __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nimport maplibregl from \"maplibre-gl\";\nimport { Geo } from \"@aws-amplify/geo\";\nimport { drawGeofences } from \"../drawGeofences\";\nimport { isValidGeofenceId, getGeofenceFeatureFromPolygon, getGeofenceFeatureArray, isExistingGeofenceId, getDistanceBetweenCoordinates } from \"../geofenceUtils\";\nimport { GEOFENCE_COLOR, GEOFENCE_BORDER_COLOR } from \"../constants\";\nimport { AmplifyGeofenceControlUI } from \"./ui\";\nimport { AmplifyMapDraw } from \"./AmplifyMapDraw\";\nimport { createElement } from \"../utils\";\nconst FIT_BOUNDS_PADDING = {\n  left: 240\n}; // Default to 240px right now because of the left nav\n\nexport class AmplifyGeofenceControl {\n  constructor(options) {\n    this._geofenceCollectionId = options === null || options === void 0 ? void 0 : options.geofenceCollectionId;\n    this._loadedGeofences = {};\n    this._displayedGeofences = [];\n    this.changeMode = this.changeMode.bind(this);\n    this.loadInitialGeofences = this.loadInitialGeofences.bind(this);\n    this.loadMoreGeofences = this.loadMoreGeofences.bind(this);\n    this._loadGeofence = this._loadGeofence.bind(this);\n    this.updateInputRadius = this.updateInputRadius.bind(this);\n    this.saveGeofence = this.saveGeofence.bind(this);\n    this.editGeofence = this.editGeofence.bind(this);\n    this.deleteGeofence = this.deleteGeofence.bind(this);\n    this.displayAllGeofences = this.displayAllGeofences.bind(this);\n    this.hideAllGeofences = this.hideAllGeofences.bind(this);\n    this.addEditableGeofence = this.addEditableGeofence.bind(this);\n    this.setEditingModeEnabled = this.setEditingModeEnabled.bind(this);\n    this.displayHighlightedGeofence = this.displayHighlightedGeofence.bind(this);\n    this.hideHighlightedGeofence = this.hideHighlightedGeofence.bind(this);\n    this.displayGeofence = this.displayGeofence.bind(this);\n    this.hideGeofence = this.hideGeofence.bind(this);\n    this.fitGeofence = this.fitGeofence.bind(this);\n    this.fitAllGeofences = this.fitAllGeofences.bind(this);\n  }\n  /**********************************************************************\n   Public Methods for AmplifyGeofenceControl\n   **********************************************************************/\n\n\n  getDefaultPosition() {\n    return \"full-screen\";\n  }\n\n  onRemove() {\n    this._ui.removeElement(this._container);\n  } // Reorders MapLibre canvas class names to fix a mapbox draw bug - https://github.com/mapbox/mapbox-gl-draw/pull/1079\n\n\n  reorderMapLibreClassNames() {\n    const mapCanvas = document.getElementsByClassName(\"maplibregl-canvas\").item(0);\n\n    if (mapCanvas) {\n      mapCanvas.className = \"mapboxgl-canvas maplibregl-canvas\";\n    }\n  }\n\n  onAdd(map) {\n    this._map = map;\n    this.reorderMapLibreClassNames();\n    this._container = createElement(\"div\", \"geofence-ctrl maplibregl-ctrl\");\n    this._ui = AmplifyGeofenceControlUI(this, this._container);\n    this._amplifyDraw = new AmplifyMapDraw(map, this._ui);\n\n    this._ui.registerControlPosition(map, \"full-screen\");\n\n    this._ui.createGeofenceListContainer(); // Draw the geofences source to the map so we can update it on geofences load/creation\n\n\n    this._map.once(\"load\", function () {\n      // Prevents warnings on multiple re-renders, especially when rendered in react\n      if (this._map.getSource(\"displayedGeofences\")) {\n        return;\n      }\n\n      this._drawGeofencesOutput = drawGeofences(\"displayedGeofences\", [], this._map, {\n        fillColor: GEOFENCE_COLOR,\n        borderColor: GEOFENCE_BORDER_COLOR,\n        borderOpacity: 1\n      });\n      this._highlightedGeofenceOutput = drawGeofences(\"highlightedGeofence\", [], this._map, {\n        fillColor: GEOFENCE_COLOR,\n        borderColor: GEOFENCE_BORDER_COLOR,\n        borderOpacity: 1,\n        borderWidth: 6\n      });\n      this.loadInitialGeofences();\n      map.addControl(new maplibregl.NavigationControl({\n        showCompass: false\n      }), \"bottom-right\");\n    }.bind(this));\n\n    this._map.on(\"draw.update\", () => {\n      const coordinates = this._amplifyDraw._mapBoxDraw.getAll().features[0].geometry.coordinates[0];\n\n      const radius = getDistanceBetweenCoordinates(coordinates[0], coordinates[Math.floor(coordinates.length / 2)]) / 2;\n\n      this._ui.updateGeofenceRadius(radius.toFixed(2));\n    });\n\n    return this._container;\n  }\n\n  createGeofence(geofenceId) {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (!geofenceId || geofenceId.length === 0) {\n        this._ui.createAddGeofencePromptError(\"Geofence ID is empty.\");\n\n        return;\n      }\n\n      if (!isValidGeofenceId(geofenceId)) {\n        this._ui.createAddGeofencePromptError(\"Geofence ID contains special characters.\");\n\n        return;\n      }\n\n      if (isExistingGeofenceId(geofenceId, this._loadedGeofences)) {\n        this._ui.createAddGeofencePromptError(\"Geofence ID already exists.\");\n\n        return;\n      }\n\n      return this.saveGeofence(geofenceId);\n    });\n  }\n\n  saveGeofence(geofenceId) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const feature = this._amplifyDraw.get(this._editingGeofenceId);\n\n      const idToSave = geofenceId || this._editingGeofenceId;\n      const response = yield Geo.saveGeofences({\n        geofenceId: idToSave,\n        geometry: {\n          polygon: feature.geometry[\"coordinates\"]\n        }\n      });\n\n      if (response.errors[0]) {\n        const err = response.errors[0];\n        throw new Error(`There was an error saving geofence with id ${idToSave}: ${err.error.code} - ${err.error.message}`);\n      }\n\n      const success = response.successes[0];\n      const savedGeofence = {\n        geofenceId: success.geofenceId,\n        geometry: {\n          polygon: feature.geometry[\"coordinates\"]\n        }\n      }; // render geofence to the map and add it to the list\n\n      this._loadGeofence(savedGeofence);\n\n      this.displayGeofence(savedGeofence.geofenceId);\n      this.setEditingModeEnabled(false);\n      return savedGeofence.geofenceId;\n    });\n  } // Each page loads 100 geofences\n\n\n  loadInitialGeofences() {\n    return __awaiter(this, void 0, void 0, function* () {\n      try {\n        const {\n          entries,\n          nextToken\n        } = yield Geo.listGeofences();\n        this._listGeofencesNextToken = nextToken;\n        const loadGeofence = this._loadGeofence;\n        entries.forEach(geofence => loadGeofence(geofence));\n\n        this._ui.updateGeofenceCount(Object.keys(this._loadedGeofences).length);\n      } catch (e) {\n        throw new Error(`Error calling listGeofences: ${e}`);\n      }\n    });\n  }\n\n  loadMoreGeofences() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (this._listGeofencesNextToken) {\n        try {\n          const {\n            entries,\n            nextToken\n          } = yield Geo.listGeofences({\n            nextToken: this._listGeofencesNextToken\n          });\n          this._listGeofencesNextToken = nextToken;\n          const loadGeofence = this._loadGeofence;\n          entries.forEach(geofence => loadGeofence(geofence));\n\n          this._ui.updateGeofenceCount(Object.keys(this._loadedGeofences).length);\n        } catch (e) {\n          throw new Error(`Error calling listGeofences: ${e}`);\n        }\n      }\n    });\n  }\n\n  editGeofence(geofenceId) {\n    this.setEditingModeEnabled(true);\n    const geofence = this._loadedGeofences[geofenceId];\n\n    if (!geofence) {\n      throw new Error(`Geofence with id ${geofenceId} does not exist`);\n    } // render in mapboxdraw\n\n\n    const feature = getGeofenceFeatureFromPolygon(geofence.geometry.polygon);\n    const data = Object.assign({\n      id: geofence.geofenceId\n    }, feature);\n\n    this._amplifyDraw.add(data);\n\n    this._editingGeofenceId = geofence.geofenceId;\n  }\n\n  deleteGeofence(geofenceId) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const response = yield Geo.deleteGeofences(geofenceId);\n\n      if (response.errors[0]) {\n        const err = response.errors[0].error;\n        throw new Error(`There was an error deleting geofence with id ${geofenceId}: ${err.code} - ${err.message}`);\n      }\n\n      this._ui.removeGeofenceListItem(geofenceId);\n\n      delete this._loadedGeofences[geofenceId];\n\n      this._ui.updateGeofenceCount(Object.keys(this._loadedGeofences).length);\n\n      this._displayedGeofences = this._displayedGeofences.filter(geofence => geofence.geofenceId !== geofenceId);\n\n      this._updateDisplayedGeofences();\n\n      return geofenceId;\n    });\n  }\n\n  deleteSelectedGeofences() {\n    const idsToDelete = this._displayedGeofences.map(fence => fence.geofenceId); // FIXME: delete geofence api call here\n\n\n    idsToDelete.forEach(id => {\n      this._ui.removeGeofenceListItem(id);\n\n      delete this._loadedGeofences[id];\n    });\n    this._displayedGeofences = [];\n\n    this._updateDisplayedGeofences();\n  }\n  /**********************************************************************\n   Private methods for CRUD Geofences\n   **********************************************************************/\n\n\n  _loadGeofence(geofence) {\n    // If geofence exists remove it from displayed geofences\n    if (this._loadedGeofences[geofence.geofenceId]) {\n      this._displayedGeofences = this._displayedGeofences.filter(fence => fence.geofenceId !== geofence.geofenceId);\n    } else {\n      // If geofence doesn't exist render a new list item for it\n      this._ui.renderListItem(geofence);\n    }\n\n    this._loadedGeofences[geofence.geofenceId] = geofence;\n\n    this._ui.updateGeofenceCount(Object.keys(this._loadedGeofences).length);\n  }\n\n  displayGeofence(geofenceId) {\n    this._displayedGeofences.push(this._loadedGeofences[geofenceId]);\n\n    this._updateDisplayedGeofences();\n\n    this._ui.updateCheckbox(geofenceId, true);\n\n    this.fitAllGeofences();\n  }\n\n  displayAllGeofences() {\n    this._displayedGeofences.push(...Object.values(this._loadedGeofences));\n\n    this._updateDisplayedGeofences();\n\n    const checkboxes = document.getElementsByClassName(\"geofence-ctrl-list-item-checkbox\");\n    Array.from(checkboxes).forEach(checkbox => checkbox.checked = this._ui.getCheckboxAllValue());\n    this.fitAllGeofences();\n  }\n\n  fitGeofence(geofenceId) {\n    const mapBounds = this._map.getBounds();\n\n    const geofence = this._loadedGeofences[geofenceId];\n    geofence.geometry.polygon[0].forEach(coord => {\n      mapBounds.extend(coord);\n    });\n\n    this._map.fitBounds(mapBounds, {\n      padding: FIT_BOUNDS_PADDING\n    });\n  }\n\n  fitAllGeofences() {\n    let shouldFitBounds = false;\n\n    const mapBounds = this._map.getBounds();\n\n    this._displayedGeofences.forEach(geofence => {\n      geofence.geometry.polygon[0].forEach(coord => {\n        if (!mapBounds.contains(coord)) {\n          mapBounds.extend(coord);\n          shouldFitBounds = true;\n        }\n      });\n    });\n\n    if (shouldFitBounds) this._map.fitBounds(mapBounds, {\n      padding: FIT_BOUNDS_PADDING\n    });\n  }\n\n  hideGeofence(geofenceId) {\n    this._displayedGeofences = this._displayedGeofences.filter(geofence => geofence.geofenceId !== geofenceId);\n\n    this._updateDisplayedGeofences();\n\n    this._ui.updateCheckbox(geofenceId, false);\n  }\n\n  hideAllGeofences() {\n    this._displayedGeofences = [];\n\n    this._updateDisplayedGeofences();\n\n    const checkboxes = document.getElementsByClassName(\"geofence-ctrl-list-item-checkbox\");\n    Array.from(checkboxes).forEach(checkbox => checkbox.checked = this._ui.getCheckboxAllValue());\n  }\n\n  _updateDisplayedGeofences() {\n    const feature = getGeofenceFeatureArray(this._displayedGeofences);\n\n    this._drawGeofencesOutput.setData(feature);\n  }\n\n  displayHighlightedGeofence(geofenceId) {\n    const geofence = this._loadedGeofences[geofenceId];\n\n    if (!geofence) {\n      console.warn(`Geofence with id ${geofenceId} does not exist`);\n      return;\n    }\n\n    const feature = getGeofenceFeatureFromPolygon(geofence.geometry.polygon);\n\n    this._highlightedGeofenceOutput.setData(feature);\n\n    this._highlightedGeofenceOutput.show();\n  }\n\n  hideHighlightedGeofence() {\n    this._highlightedGeofenceOutput.hide();\n  }\n  /**********************************************************************\n   Methods for controlling amplify mapbox draw\n   **********************************************************************/\n\n\n  changeMode(mode) {\n    // erase existing mapbox draw content\n    this._amplifyDraw.delete(this._editingGeofenceId);\n\n    if (mode === \"draw_circle\") {\n      this._amplifyDraw.drawCircularGeofence(this._editingGeofenceId);\n    } else {\n      this._amplifyDraw.drawPolygonGeofence(this._editingGeofenceId);\n    }\n  }\n\n  resetGeofence() {\n    // erase existing mapbox draw content\n    this._amplifyDraw.delete(this._editingGeofenceId);\n\n    if (isExistingGeofenceId(this._editingGeofenceId, this._loadedGeofences)) {\n      this.editGeofence(this._editingGeofenceId);\n    } else {\n      this._amplifyDraw.drawPolygonGeofence(this._editingGeofenceId);\n    }\n  } // Disables add button and selecting items from geofence list\n\n\n  setEditingModeEnabled(enabled) {\n    enabled ? this._amplifyDraw.enable() : this._amplifyDraw.disable();\n    enabled ? this._drawGeofencesOutput.hide() : this._drawGeofencesOutput.show();\n\n    this._ui.setGeofenceListEnabled(!enabled);\n  }\n\n  updateInputRadius(event) {\n    const radiusString = event.target.value;\n    const radius = parseInt(radiusString);\n\n    if (isNaN(radius)) {\n      return;\n    }\n\n    this._amplifyDraw.drawCircularGeofence(this._editingGeofenceId, radius);\n  }\n\n  addEditableGeofence() {\n    this._editingGeofenceId = \"tempGeofence\";\n\n    this._amplifyDraw.drawCircularGeofence(\"tempGeofence\");\n\n    this.setEditingModeEnabled(true);\n  }\n\n}","map":{"version":3,"sources":["/home/dalienst/node_modules/maplibre-gl-js-amplify/lib/esm/AmplifyGeofenceControl/index.js"],"names":["__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","apply","maplibregl","Geo","drawGeofences","isValidGeofenceId","getGeofenceFeatureFromPolygon","getGeofenceFeatureArray","isExistingGeofenceId","getDistanceBetweenCoordinates","GEOFENCE_COLOR","GEOFENCE_BORDER_COLOR","AmplifyGeofenceControlUI","AmplifyMapDraw","createElement","FIT_BOUNDS_PADDING","left","AmplifyGeofenceControl","constructor","options","_geofenceCollectionId","geofenceCollectionId","_loadedGeofences","_displayedGeofences","changeMode","bind","loadInitialGeofences","loadMoreGeofences","_loadGeofence","updateInputRadius","saveGeofence","editGeofence","deleteGeofence","displayAllGeofences","hideAllGeofences","addEditableGeofence","setEditingModeEnabled","displayHighlightedGeofence","hideHighlightedGeofence","displayGeofence","hideGeofence","fitGeofence","fitAllGeofences","getDefaultPosition","onRemove","_ui","removeElement","_container","reorderMapLibreClassNames","mapCanvas","document","getElementsByClassName","item","className","onAdd","map","_map","_amplifyDraw","registerControlPosition","createGeofenceListContainer","once","getSource","_drawGeofencesOutput","fillColor","borderColor","borderOpacity","_highlightedGeofenceOutput","borderWidth","addControl","NavigationControl","showCompass","on","coordinates","_mapBoxDraw","getAll","features","geometry","radius","Math","floor","length","updateGeofenceRadius","toFixed","createGeofence","geofenceId","createAddGeofencePromptError","feature","get","_editingGeofenceId","idToSave","response","saveGeofences","polygon","errors","err","Error","error","code","message","success","successes","savedGeofence","entries","nextToken","listGeofences","_listGeofencesNextToken","loadGeofence","forEach","geofence","updateGeofenceCount","Object","keys","data","assign","id","add","deleteGeofences","removeGeofenceListItem","filter","_updateDisplayedGeofences","deleteSelectedGeofences","idsToDelete","fence","renderListItem","push","updateCheckbox","values","checkboxes","Array","from","checkbox","checked","getCheckboxAllValue","mapBounds","getBounds","coord","extend","fitBounds","padding","shouldFitBounds","contains","setData","console","warn","show","hide","mode","delete","drawCircularGeofence","drawPolygonGeofence","resetGeofence","enabled","enable","disable","setGeofenceListEnabled","event","radiusString","target","parseInt","isNaN"],"mappings":"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","sourcesContent":["var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nimport maplibregl from \"maplibre-gl\";\nimport { Geo } from \"@aws-amplify/geo\";\nimport { drawGeofences } from \"../drawGeofences\";\nimport { isValidGeofenceId, getGeofenceFeatureFromPolygon, getGeofenceFeatureArray, isExistingGeofenceId, getDistanceBetweenCoordinates, } from \"../geofenceUtils\";\nimport { GEOFENCE_COLOR, GEOFENCE_BORDER_COLOR } from \"../constants\";\nimport { AmplifyGeofenceControlUI } from \"./ui\";\nimport { AmplifyMapDraw } from \"./AmplifyMapDraw\";\nimport { createElement } from \"../utils\";\nconst FIT_BOUNDS_PADDING = { left: 240 }; // Default to 240px right now because of the left nav\nexport class AmplifyGeofenceControl {\n    constructor(options) {\n        this._geofenceCollectionId = options === null || options === void 0 ? void 0 : options.geofenceCollectionId;\n        this._loadedGeofences = {};\n        this._displayedGeofences = [];\n        this.changeMode = this.changeMode.bind(this);\n        this.loadInitialGeofences = this.loadInitialGeofences.bind(this);\n        this.loadMoreGeofences = this.loadMoreGeofences.bind(this);\n        this._loadGeofence = this._loadGeofence.bind(this);\n        this.updateInputRadius = this.updateInputRadius.bind(this);\n        this.saveGeofence = this.saveGeofence.bind(this);\n        this.editGeofence = this.editGeofence.bind(this);\n        this.deleteGeofence = this.deleteGeofence.bind(this);\n        this.displayAllGeofences = this.displayAllGeofences.bind(this);\n        this.hideAllGeofences = this.hideAllGeofences.bind(this);\n        this.addEditableGeofence = this.addEditableGeofence.bind(this);\n        this.setEditingModeEnabled = this.setEditingModeEnabled.bind(this);\n        this.displayHighlightedGeofence =\n            this.displayHighlightedGeofence.bind(this);\n        this.hideHighlightedGeofence = this.hideHighlightedGeofence.bind(this);\n        this.displayGeofence = this.displayGeofence.bind(this);\n        this.hideGeofence = this.hideGeofence.bind(this);\n        this.fitGeofence = this.fitGeofence.bind(this);\n        this.fitAllGeofences = this.fitAllGeofences.bind(this);\n    }\n    /**********************************************************************\n     Public Methods for AmplifyGeofenceControl\n     **********************************************************************/\n    getDefaultPosition() {\n        return \"full-screen\";\n    }\n    onRemove() {\n        this._ui.removeElement(this._container);\n    }\n    // Reorders MapLibre canvas class names to fix a mapbox draw bug - https://github.com/mapbox/mapbox-gl-draw/pull/1079\n    reorderMapLibreClassNames() {\n        const mapCanvas = document\n            .getElementsByClassName(\"maplibregl-canvas\")\n            .item(0);\n        if (mapCanvas) {\n            mapCanvas.className = \"mapboxgl-canvas maplibregl-canvas\";\n        }\n    }\n    onAdd(map) {\n        this._map = map;\n        this.reorderMapLibreClassNames();\n        this._container = createElement(\"div\", \"geofence-ctrl maplibregl-ctrl\");\n        this._ui = AmplifyGeofenceControlUI(this, this._container);\n        this._amplifyDraw = new AmplifyMapDraw(map, this._ui);\n        this._ui.registerControlPosition(map, \"full-screen\");\n        this._ui.createGeofenceListContainer();\n        // Draw the geofences source to the map so we can update it on geofences load/creation\n        this._map.once(\"load\", function () {\n            // Prevents warnings on multiple re-renders, especially when rendered in react\n            if (this._map.getSource(\"displayedGeofences\")) {\n                return;\n            }\n            this._drawGeofencesOutput = drawGeofences(\"displayedGeofences\", [], this._map, {\n                fillColor: GEOFENCE_COLOR,\n                borderColor: GEOFENCE_BORDER_COLOR,\n                borderOpacity: 1,\n            });\n            this._highlightedGeofenceOutput = drawGeofences(\"highlightedGeofence\", [], this._map, {\n                fillColor: GEOFENCE_COLOR,\n                borderColor: GEOFENCE_BORDER_COLOR,\n                borderOpacity: 1,\n                borderWidth: 6,\n            });\n            this.loadInitialGeofences();\n            map.addControl(new maplibregl.NavigationControl({ showCompass: false }), \"bottom-right\");\n        }.bind(this));\n        this._map.on(\"draw.update\", () => {\n            const coordinates = this._amplifyDraw._mapBoxDraw.getAll().features[0].geometry.coordinates[0];\n            const radius = getDistanceBetweenCoordinates(coordinates[0], coordinates[Math.floor(coordinates.length / 2)]) / 2;\n            this._ui.updateGeofenceRadius(radius.toFixed(2));\n        });\n        return this._container;\n    }\n    createGeofence(geofenceId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (!geofenceId || geofenceId.length === 0) {\n                this._ui.createAddGeofencePromptError(\"Geofence ID is empty.\");\n                return;\n            }\n            if (!isValidGeofenceId(geofenceId)) {\n                this._ui.createAddGeofencePromptError(\"Geofence ID contains special characters.\");\n                return;\n            }\n            if (isExistingGeofenceId(geofenceId, this._loadedGeofences)) {\n                this._ui.createAddGeofencePromptError(\"Geofence ID already exists.\");\n                return;\n            }\n            return this.saveGeofence(geofenceId);\n        });\n    }\n    saveGeofence(geofenceId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const feature = this._amplifyDraw.get(this._editingGeofenceId);\n            const idToSave = geofenceId || this._editingGeofenceId;\n            const response = yield Geo.saveGeofences({\n                geofenceId: idToSave,\n                geometry: { polygon: feature.geometry[\"coordinates\"] },\n            });\n            if (response.errors[0]) {\n                const err = response.errors[0];\n                throw new Error(`There was an error saving geofence with id ${idToSave}: ${err.error.code} - ${err.error.message}`);\n            }\n            const success = response.successes[0];\n            const savedGeofence = {\n                geofenceId: success.geofenceId,\n                geometry: { polygon: feature.geometry[\"coordinates\"] },\n            };\n            // render geofence to the map and add it to the list\n            this._loadGeofence(savedGeofence);\n            this.displayGeofence(savedGeofence.geofenceId);\n            this.setEditingModeEnabled(false);\n            return savedGeofence.geofenceId;\n        });\n    }\n    // Each page loads 100 geofences\n    loadInitialGeofences() {\n        return __awaiter(this, void 0, void 0, function* () {\n            try {\n                const { entries, nextToken } = yield Geo.listGeofences();\n                this._listGeofencesNextToken = nextToken;\n                const loadGeofence = this._loadGeofence;\n                entries.forEach((geofence) => loadGeofence(geofence));\n                this._ui.updateGeofenceCount(Object.keys(this._loadedGeofences).length);\n            }\n            catch (e) {\n                throw new Error(`Error calling listGeofences: ${e}`);\n            }\n        });\n    }\n    loadMoreGeofences() {\n        return __awaiter(this, void 0, void 0, function* () {\n            if (this._listGeofencesNextToken) {\n                try {\n                    const { entries, nextToken } = yield Geo.listGeofences({\n                        nextToken: this._listGeofencesNextToken,\n                    });\n                    this._listGeofencesNextToken = nextToken;\n                    const loadGeofence = this._loadGeofence;\n                    entries.forEach((geofence) => loadGeofence(geofence));\n                    this._ui.updateGeofenceCount(Object.keys(this._loadedGeofences).length);\n                }\n                catch (e) {\n                    throw new Error(`Error calling listGeofences: ${e}`);\n                }\n            }\n        });\n    }\n    editGeofence(geofenceId) {\n        this.setEditingModeEnabled(true);\n        const geofence = this._loadedGeofences[geofenceId];\n        if (!geofence) {\n            throw new Error(`Geofence with id ${geofenceId} does not exist`);\n        }\n        // render in mapboxdraw\n        const feature = getGeofenceFeatureFromPolygon(geofence.geometry.polygon);\n        const data = Object.assign({ id: geofence.geofenceId }, feature);\n        this._amplifyDraw.add(data);\n        this._editingGeofenceId = geofence.geofenceId;\n    }\n    deleteGeofence(geofenceId) {\n        return __awaiter(this, void 0, void 0, function* () {\n            const response = yield Geo.deleteGeofences(geofenceId);\n            if (response.errors[0]) {\n                const err = response.errors[0].error;\n                throw new Error(`There was an error deleting geofence with id ${geofenceId}: ${err.code} - ${err.message}`);\n            }\n            this._ui.removeGeofenceListItem(geofenceId);\n            delete this._loadedGeofences[geofenceId];\n            this._ui.updateGeofenceCount(Object.keys(this._loadedGeofences).length);\n            this._displayedGeofences = this._displayedGeofences.filter((geofence) => geofence.geofenceId !== geofenceId);\n            this._updateDisplayedGeofences();\n            return geofenceId;\n        });\n    }\n    deleteSelectedGeofences() {\n        const idsToDelete = this._displayedGeofences.map((fence) => fence.geofenceId);\n        // FIXME: delete geofence api call here\n        idsToDelete.forEach((id) => {\n            this._ui.removeGeofenceListItem(id);\n            delete this._loadedGeofences[id];\n        });\n        this._displayedGeofences = [];\n        this._updateDisplayedGeofences();\n    }\n    /**********************************************************************\n     Private methods for CRUD Geofences\n     **********************************************************************/\n    _loadGeofence(geofence) {\n        // If geofence exists remove it from displayed geofences\n        if (this._loadedGeofences[geofence.geofenceId]) {\n            this._displayedGeofences = this._displayedGeofences.filter((fence) => fence.geofenceId !== geofence.geofenceId);\n        }\n        else {\n            // If geofence doesn't exist render a new list item for it\n            this._ui.renderListItem(geofence);\n        }\n        this._loadedGeofences[geofence.geofenceId] = geofence;\n        this._ui.updateGeofenceCount(Object.keys(this._loadedGeofences).length);\n    }\n    displayGeofence(geofenceId) {\n        this._displayedGeofences.push(this._loadedGeofences[geofenceId]);\n        this._updateDisplayedGeofences();\n        this._ui.updateCheckbox(geofenceId, true);\n        this.fitAllGeofences();\n    }\n    displayAllGeofences() {\n        this._displayedGeofences.push(...Object.values(this._loadedGeofences));\n        this._updateDisplayedGeofences();\n        const checkboxes = document.getElementsByClassName(\"geofence-ctrl-list-item-checkbox\");\n        Array.from(checkboxes).forEach((checkbox) => (checkbox.checked = this._ui.getCheckboxAllValue()));\n        this.fitAllGeofences();\n    }\n    fitGeofence(geofenceId) {\n        const mapBounds = this._map.getBounds();\n        const geofence = this._loadedGeofences[geofenceId];\n        geofence.geometry.polygon[0].forEach((coord) => {\n            mapBounds.extend(coord);\n        });\n        this._map.fitBounds(mapBounds, { padding: FIT_BOUNDS_PADDING });\n    }\n    fitAllGeofences() {\n        let shouldFitBounds = false;\n        const mapBounds = this._map.getBounds();\n        this._displayedGeofences.forEach((geofence) => {\n            geofence.geometry.polygon[0].forEach((coord) => {\n                if (!mapBounds.contains(coord)) {\n                    mapBounds.extend(coord);\n                    shouldFitBounds = true;\n                }\n            });\n        });\n        if (shouldFitBounds)\n            this._map.fitBounds(mapBounds, { padding: FIT_BOUNDS_PADDING });\n    }\n    hideGeofence(geofenceId) {\n        this._displayedGeofences = this._displayedGeofences.filter((geofence) => geofence.geofenceId !== geofenceId);\n        this._updateDisplayedGeofences();\n        this._ui.updateCheckbox(geofenceId, false);\n    }\n    hideAllGeofences() {\n        this._displayedGeofences = [];\n        this._updateDisplayedGeofences();\n        const checkboxes = document.getElementsByClassName(\"geofence-ctrl-list-item-checkbox\");\n        Array.from(checkboxes).forEach((checkbox) => (checkbox.checked = this._ui.getCheckboxAllValue()));\n    }\n    _updateDisplayedGeofences() {\n        const feature = getGeofenceFeatureArray(this._displayedGeofences);\n        this._drawGeofencesOutput.setData(feature);\n    }\n    displayHighlightedGeofence(geofenceId) {\n        const geofence = this._loadedGeofences[geofenceId];\n        if (!geofence) {\n            console.warn(`Geofence with id ${geofenceId} does not exist`);\n            return;\n        }\n        const feature = getGeofenceFeatureFromPolygon(geofence.geometry.polygon);\n        this._highlightedGeofenceOutput.setData(feature);\n        this._highlightedGeofenceOutput.show();\n    }\n    hideHighlightedGeofence() {\n        this._highlightedGeofenceOutput.hide();\n    }\n    /**********************************************************************\n     Methods for controlling amplify mapbox draw\n     **********************************************************************/\n    changeMode(mode) {\n        // erase existing mapbox draw content\n        this._amplifyDraw.delete(this._editingGeofenceId);\n        if (mode === \"draw_circle\") {\n            this._amplifyDraw.drawCircularGeofence(this._editingGeofenceId);\n        }\n        else {\n            this._amplifyDraw.drawPolygonGeofence(this._editingGeofenceId);\n        }\n    }\n    resetGeofence() {\n        // erase existing mapbox draw content\n        this._amplifyDraw.delete(this._editingGeofenceId);\n        if (isExistingGeofenceId(this._editingGeofenceId, this._loadedGeofences)) {\n            this.editGeofence(this._editingGeofenceId);\n        }\n        else {\n            this._amplifyDraw.drawPolygonGeofence(this._editingGeofenceId);\n        }\n    }\n    // Disables add button and selecting items from geofence list\n    setEditingModeEnabled(enabled) {\n        enabled ? this._amplifyDraw.enable() : this._amplifyDraw.disable();\n        enabled\n            ? this._drawGeofencesOutput.hide()\n            : this._drawGeofencesOutput.show();\n        this._ui.setGeofenceListEnabled(!enabled);\n    }\n    updateInputRadius(event) {\n        const radiusString = event.target.value;\n        const radius = parseInt(radiusString);\n        if (isNaN(radius)) {\n            return;\n        }\n        this._amplifyDraw.drawCircularGeofence(this._editingGeofenceId, radius);\n    }\n    addEditableGeofence() {\n        this._editingGeofenceId = \"tempGeofence\";\n        this._amplifyDraw.drawCircularGeofence(\"tempGeofence\");\n        this.setEditingModeEnabled(true);\n    }\n}\n"]},"metadata":{},"sourceType":"module"}