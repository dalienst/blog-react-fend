{"ast":null,"code":"// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nimport { __awaiter, __generator } from \"tslib\";\nimport { MethodEmbed } from '../utils/MethodEmbed';\nimport { ConsoleLogger as Logger, browserOrNode } from '@aws-amplify/core';\nvar logger = new Logger('PageViewTracker');\nvar PREV_URL_KEY = 'aws-amplify-analytics-prevUrl';\n\nvar getUrl = function () {\n  if (!browserOrNode().isBrowser) return '';else return window.location.origin + window.location.pathname;\n};\n\nvar defaultOpts = {\n  enable: false,\n  provider: 'AWSPinpoint',\n  getUrl: getUrl\n};\n\nvar PageViewTracker =\n/** @class */\nfunction () {\n  function PageViewTracker(tracker, opts) {\n    logger.debug('initialize pageview tracker with opts', opts);\n    this._config = Object.assign({}, defaultOpts, opts);\n    this._tracker = tracker;\n    this._hasEnabled = false;\n    this._trackFunc = this._trackFunc.bind(this);\n\n    if (this._config.type === 'SPA') {\n      this._pageViewTrackSPA();\n    } else {\n      this._pageViewTrackDefault();\n    }\n  }\n\n  PageViewTracker.prototype.configure = function (opts) {\n    Object.assign(this._config, opts); // if spa, need to remove those listeners if disabled\n\n    if (this._config.type === 'SPA') {\n      this._pageViewTrackSPA();\n    }\n\n    return this._config;\n  };\n\n  PageViewTracker.prototype._isSameUrl = function () {\n    var prevUrl = sessionStorage.getItem(PREV_URL_KEY);\n\n    var curUrl = this._config.getUrl();\n\n    if (prevUrl === curUrl) {\n      logger.debug('the url is same');\n      return true;\n    } else return false;\n  };\n\n  PageViewTracker.prototype._pageViewTrackDefault = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var url, customAttrs, _a, attributes;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            if (!browserOrNode().isBrowser || !window.addEventListener || !window.sessionStorage) {\n              logger.debug('not in the supported web enviroment');\n              return [2\n              /*return*/\n              ];\n            }\n\n            url = this._config.getUrl();\n            if (!(typeof this._config.attributes === 'function')) return [3\n            /*break*/\n            , 2];\n            return [4\n            /*yield*/\n            , this._config.attributes()];\n\n          case 1:\n            _a = _b.sent();\n            return [3\n            /*break*/\n            , 3];\n\n          case 2:\n            _a = this._config.attributes;\n            _b.label = 3;\n\n          case 3:\n            customAttrs = _a;\n            attributes = Object.assign({\n              url: url\n            }, customAttrs);\n\n            if (this._config.enable && !this._isSameUrl()) {\n              this._tracker({\n                name: this._config.eventName || 'pageView',\n                attributes: attributes\n              }, this._config.provider).catch(function (e) {\n                logger.debug('Failed to record the page view event', e);\n              });\n\n              sessionStorage.setItem(PREV_URL_KEY, url);\n            }\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  PageViewTracker.prototype._trackFunc = function () {\n    return __awaiter(this, void 0, void 0, function () {\n      var url, customAttrs, _a, attributes;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            if (!browserOrNode().isBrowser || !window.addEventListener || !history.pushState || !window.sessionStorage) {\n              logger.debug('not in the supported web enviroment');\n              return [2\n              /*return*/\n              ];\n            }\n\n            url = this._config.getUrl();\n            if (!(typeof this._config.attributes === 'function')) return [3\n            /*break*/\n            , 2];\n            return [4\n            /*yield*/\n            , this._config.attributes()];\n\n          case 1:\n            _a = _b.sent();\n            return [3\n            /*break*/\n            , 3];\n\n          case 2:\n            _a = this._config.attributes;\n            _b.label = 3;\n\n          case 3:\n            customAttrs = _a;\n            attributes = Object.assign({\n              url: url\n            }, customAttrs);\n\n            if (!this._isSameUrl()) {\n              this._tracker({\n                name: this._config.eventName || 'pageView',\n                attributes: attributes\n              }, this._config.provider).catch(function (e) {\n                logger.debug('Failed to record the page view event', e);\n              });\n\n              sessionStorage.setItem(PREV_URL_KEY, url);\n            }\n\n            return [2\n            /*return*/\n            ];\n        }\n      });\n    });\n  };\n\n  PageViewTracker.prototype._pageViewTrackSPA = function () {\n    if (!browserOrNode().isBrowser || !window.addEventListener || !history.pushState) {\n      logger.debug('not in the supported web enviroment');\n      return;\n    }\n\n    if (this._config.enable && !this._hasEnabled) {\n      MethodEmbed.add(history, 'pushState', this._trackFunc);\n      MethodEmbed.add(history, 'replaceState', this._trackFunc);\n      window.addEventListener('popstate', this._trackFunc);\n\n      this._trackFunc();\n\n      this._hasEnabled = true;\n    } else {\n      MethodEmbed.remove(history, 'pushState');\n      MethodEmbed.remove(history, 'replaceState');\n      window.removeEventListener('popstate', this._trackFunc);\n      this._hasEnabled = false;\n    }\n  };\n\n  return PageViewTracker;\n}();\n\nexport { PageViewTracker };","map":{"version":3,"mappings":"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","names":["MethodEmbed","ConsoleLogger","Logger","browserOrNode","logger","PREV_URL_KEY","getUrl","isBrowser","window","location","origin","pathname","defaultOpts","enable","provider","tracker","opts","debug","_config","Object","assign","_tracker","_hasEnabled","_trackFunc","bind","type","_pageViewTrackSPA","_pageViewTrackDefault","PageViewTracker","prevUrl","sessionStorage","getItem","curUrl","addEventListener","url","attributes","_a","customAttrs","_isSameUrl","name","eventName","catch","e","setItem","history","pushState","add","remove","removeEventListener"],"sources":["/home/dalienst/node_modules/@aws-amplify/analytics/src/trackers/PageViewTracker.ts"],"sourcesContent":["// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nimport { pageViewTrackOpts } from '../types';\nimport { MethodEmbed } from '../utils/MethodEmbed';\nimport { ConsoleLogger as Logger, browserOrNode } from '@aws-amplify/core';\n\nconst logger = new Logger('PageViewTracker');\nconst PREV_URL_KEY = 'aws-amplify-analytics-prevUrl';\n\nconst getUrl = () => {\n\tif (!browserOrNode().isBrowser) return '';\n\telse return window.location.origin + window.location.pathname;\n};\n\nconst defaultOpts: pageViewTrackOpts = {\n\tenable: false,\n\tprovider: 'AWSPinpoint',\n\tgetUrl,\n};\n\nexport class PageViewTracker {\n\tprivate _config: pageViewTrackOpts;\n\tprivate _tracker;\n\tprivate _hasEnabled;\n\n\tconstructor(tracker, opts) {\n\t\tlogger.debug('initialize pageview tracker with opts', opts);\n\t\tthis._config = Object.assign({}, defaultOpts, opts);\n\t\tthis._tracker = tracker;\n\t\tthis._hasEnabled = false;\n\t\tthis._trackFunc = this._trackFunc.bind(this);\n\n\t\tif (this._config.type === 'SPA') {\n\t\t\tthis._pageViewTrackSPA();\n\t\t} else {\n\t\t\tthis._pageViewTrackDefault();\n\t\t}\n\t}\n\n\tpublic configure(opts?: pageViewTrackOpts) {\n\t\tObject.assign(this._config, opts);\n\n\t\t// if spa, need to remove those listeners if disabled\n\t\tif (this._config.type === 'SPA') {\n\t\t\tthis._pageViewTrackSPA();\n\t\t}\n\n\t\treturn this._config;\n\t}\n\n\tprivate _isSameUrl() {\n\t\tconst prevUrl = sessionStorage.getItem(PREV_URL_KEY);\n\t\tconst curUrl = this._config.getUrl();\n\n\t\tif (prevUrl === curUrl) {\n\t\t\tlogger.debug('the url is same');\n\t\t\treturn true;\n\t\t} else return false;\n\t}\n\n\tprivate async _pageViewTrackDefault() {\n\t\tif (\n\t\t\t!browserOrNode().isBrowser ||\n\t\t\t!window.addEventListener ||\n\t\t\t!window.sessionStorage\n\t\t) {\n\t\t\tlogger.debug('not in the supported web enviroment');\n\t\t\treturn;\n\t\t}\n\t\tconst url = this._config.getUrl();\n\t\tconst customAttrs =\n\t\t\ttypeof this._config.attributes === 'function'\n\t\t\t\t? await this._config.attributes()\n\t\t\t\t: this._config.attributes;\n\t\tconst attributes = Object.assign(\n\t\t\t{\n\t\t\t\turl,\n\t\t\t},\n\t\t\tcustomAttrs\n\t\t);\n\n\t\tif (this._config.enable && !this._isSameUrl()) {\n\t\t\tthis._tracker(\n\t\t\t\t{\n\t\t\t\t\tname: this._config.eventName || 'pageView',\n\t\t\t\t\tattributes,\n\t\t\t\t},\n\t\t\t\tthis._config.provider\n\t\t\t).catch(e => {\n\t\t\t\tlogger.debug('Failed to record the page view event', e);\n\t\t\t});\n\t\t\tsessionStorage.setItem(PREV_URL_KEY, url);\n\t\t}\n\t}\n\n\tprivate async _trackFunc() {\n\t\tif (\n\t\t\t!browserOrNode().isBrowser ||\n\t\t\t!window.addEventListener ||\n\t\t\t!history.pushState ||\n\t\t\t!window.sessionStorage\n\t\t) {\n\t\t\tlogger.debug('not in the supported web enviroment');\n\t\t\treturn;\n\t\t}\n\n\t\tconst url = this._config.getUrl();\n\t\tconst customAttrs =\n\t\t\ttypeof this._config.attributes === 'function'\n\t\t\t\t? await this._config.attributes()\n\t\t\t\t: this._config.attributes;\n\t\tconst attributes = Object.assign(\n\t\t\t{\n\t\t\t\turl,\n\t\t\t},\n\t\t\tcustomAttrs\n\t\t);\n\n\t\tif (!this._isSameUrl()) {\n\t\t\tthis._tracker(\n\t\t\t\t{\n\t\t\t\t\tname: this._config.eventName || 'pageView',\n\t\t\t\t\tattributes,\n\t\t\t\t},\n\t\t\t\tthis._config.provider\n\t\t\t).catch(e => {\n\t\t\t\tlogger.debug('Failed to record the page view event', e);\n\t\t\t});\n\t\t\tsessionStorage.setItem(PREV_URL_KEY, url);\n\t\t}\n\t}\n\n\tprivate _pageViewTrackSPA() {\n\t\tif (\n\t\t\t!browserOrNode().isBrowser ||\n\t\t\t!window.addEventListener ||\n\t\t\t!history.pushState\n\t\t) {\n\t\t\tlogger.debug('not in the supported web enviroment');\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._config.enable && !this._hasEnabled) {\n\t\t\tMethodEmbed.add(history, 'pushState', this._trackFunc);\n\t\t\tMethodEmbed.add(history, 'replaceState', this._trackFunc);\n\t\t\twindow.addEventListener('popstate', this._trackFunc);\n\t\t\tthis._trackFunc();\n\t\t\tthis._hasEnabled = true;\n\t\t} else {\n\t\t\tMethodEmbed.remove(history, 'pushState');\n\t\t\tMethodEmbed.remove(history, 'replaceState');\n\t\t\twindow.removeEventListener('popstate', this._trackFunc);\n\t\t\tthis._hasEnabled = false;\n\t\t}\n\t}\n}\n"]},"metadata":{},"sourceType":"module"}